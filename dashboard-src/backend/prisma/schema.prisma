// Prisma Schema - LearnSphere Industrial-Grade LMS
// This schema enforces strict relationships and enums for roles and types

generator client {
  provider = "prisma-client-js"
}

// Using SQLite for seamless local development, easy to switch to PostgreSQL
datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// User Roles Defined as Enum for Strict Typing
// Enforces: Admin, Teacher, User (Student)
model User {
  id             String        @id @default(uuid())
  email          String        @unique
  passwordHash   String
  name           String
  role           String        @default("user") // "admin", "teacher", "user"
  createdAt      DateTime      @default(now())
  
  // Relations
  coursesManaged Course[]      @relation("CourseAdmin")
  enrollments    Enrollment[]
  quizAttempts   QuizAttempts[]
  progress       UserProgress[]

  // Gamification Profile
  points         Int           @default(0)
  rank           String        @default("Newbie") // Explorer, Achiever, Specialist, Expert, Master
}

model Course {
  id             String        @id @default(uuid())
  title          String
  slug           String        @unique // For URL-friendly access
  description    String?
  thumbnail      String?
  status         String        @default("draft") // "draft", "published", "archived"
  
  // Access Control Rules
  visibility     String        @default("everyone") // "everyone", "signed_in"
  accessRule     String        @default("open")     // "open", "invite", "payment"
  price          Float?        @default(0.0)

  // Ownership
  adminId        String
  admin          User          @relation("CourseAdmin", fields: [adminId], references: [id])

  // Content
  modules        Module[]
  enrollments    Enrollment[]

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Module {
  id             String        @id @default(uuid())
  title          String
  courseId       String
  course         Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons        Lesson[]
  orderIndex     Int           @default(0)
}

model Lesson {
  id             String        @id @default(uuid())
  moduleId       String
  module         Module        @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  title          String
  type           String        // "video", "document", "quiz"
  contentUrl     String?       // URL for video/doc
  description    String?
  duration       Int?          // Minutes

  // Quiz Specifics (JSON blob for simple structure, or separate table for strict SQL)
  quizData       String?       // Stored as JSON string: { questions: [{ q: "", options: [], answer: "" }] }
  basePoints     Int           @default(10) // Points awarded for first attempt

  orderIndex     Int           @default(0)
  progress       UserProgress[]
  quizAttempts   QuizAttempts[]
}

model Enrollment {
  id             String        @id @default(uuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId       String
  course         Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  status         String        @default("active") // "active", "completed", "dropped"
  joinedAt       DateTime      @default(now())
  completedAt    DateTime?

  @@unique([userId, courseId]) // Prevent double enrollment
}

model UserProgress {
  id             String        @id @default(uuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId       String
  lesson         Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  isCompleted    Boolean       @default(false)
  completedAt    DateTime?
  
  @@unique([userId, lessonId])
}

model QuizAttempts {
  id             String        @id @default(uuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId       String
  lesson         Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  score          Int           // Percentage 0-100
  attemptNumber  Int           @default(1)
  pointsEarned   Int           @default(0)
  
  createdAt      DateTime      @default(now())
}
